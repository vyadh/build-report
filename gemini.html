<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Build Report</title>
    <style>
        :root {
            --primary-bg-color: #1e1e1e;
            --secondary-bg-color: #2a2a2a;
            --tertiary-bg-color: #333333;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #b0b0b0;
            --accent-color: #00aaff;
            --link-color: #00aaff;
            --link-hover-color: #0088cc;
            --border-color: #444444;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --card-padding: 20px;
            --card-border-radius: 8px;
            --section-spacing: 25px;
        }

        body.build-report-body {
            background-color: var(--primary-bg-color);
            color: var(--primary-text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .build-report-container {
            background-color: var(--secondary-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--card-border-radius);
            padding: var(--card-padding);
            margin: 20px; /* Provides spacing if embedded directly on a similar bg */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .report-header {
            text-align: center;
            margin-bottom: var(--section-spacing);
            padding-bottom: var(--section-spacing);
            border-bottom: 2px solid var(--accent-color);
        }

        .report-header h1 {
            font-size: 2.5em;
            color: var(--accent-color);
            margin: 0 0 10px 0;
        }

        .report-header .app-name {
            font-size: 1.8em;
            color: var(--primary-text-color);
            margin-top: 0;
        }

        .report-section {
            margin-bottom: var(--section-spacing);
            background-color: var(--tertiary-bg-color);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
        }

        .report-section h2 {
            font-size: 1.5em;
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .property-item {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: var(--card-border-radius);
            border: 1px solid var(--border-color);
            word-break: break-word; /* Prevents long strings from breaking layout */
        }

        .property-item .label {
            display: block;
            color: var(--primary-text-color);
            margin-bottom: 5px;
            font-size: 0.95em;
            font-weight: bold;
        }

        .property-item span, .property-item a {
            color: var(--secondary-text-color);
            font-size: 0.9em;
        }

        .property-item a {
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .property-item a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        .prominent {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-text-color);
        }

        .optional-item {
            opacity: 0.8;
        }

        .status-protected {
            color: var(--success-color);
            font-weight: bold;
        }
        .status-unprotected {
            color: var(--warning-color);
            font-weight: bold;
        }

        .artefacts-list {
            list-style: none;
            padding: 0;
        }

        .artefacts-list li {
            background-color: var(--secondary-bg-color);
            padding: 10px 15px;
            border-radius: var(--card-border-radius);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .artefacts-list .artefact-name {
            font-weight: bold;
            color: var(--primary-text-color);
        }
        .artefacts-list .artefact-type {
            font-style: italic;
            color: var(--secondary-text-color);
            margin-left: 10px;
        }
        .artefacts-list a {
            color: var(--link-color);
            text-decoration: none;
            margin-left: auto; /* Pushes link to the right */
            padding-left: 15px; /* Space before link */
        }
        .artefacts-list a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .report-header h1 {
                font-size: 2em;
            }
            .report-header .app-name {
                font-size: 1.5em;
            }
            .grid-container {
                grid-template-columns: 1fr; /* Stack items on smaller screens */
            }
            .artefacts-list li {
                flex-direction: column;
                align-items: flex-start;
            }
            .artefacts-list a {
                margin-left: 0;
                margin-top: 5px;
                padding-left: 0;
            }
        }

        /* Ensure self-contained visual distinctness */
        .build-report-container.embedded {
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.2); /* Subtle glow in accent color */
            border: 1px solid var(--accent-color);
        }

    </style>
</head>
<body class="build-report-body">

<div class="build-report-container embedded">
    <header class="report-header">
        <h1><span id="project-name"></span></h1>
        <p class="app-name"><span id="application-name"></span></p>
        <p class="optional-item" id="projectDescriptionContainer" style="display: none;">
            Description: <span id="project-description"></span>
        </p>
    </header>

    <section class="report-section">
        <h2>Build & Version</h2>
        <div class="grid-container">
            <div class="property-item" id="versionContainer" style="display: none;">
                <span class="label">Version:</span>
                <a href="#" id="version" target="_blank" class="prominent"></a>
            </div>
            <div class="property-item">
                <span class="label">Build Reference:</span>
                <a href="#" id="build-reference" target="_blank" class="prominent"></a>
            </div>
            <div class="property-item">
                <span class="label">Timestamp:</span>
                <span id="timestamp"></span>
            </div>
            <div class="property-item">
                <span class="label">Maturity:</span>
                <span id="project-maturity"></span>
            </div>
            <div class="property-item">
                <span class="label">Type:</span>
                <span id="project-type" class="prominent"></span>
            </div>
        </div>
    </section>

    <section class="report-section">
        <h2>Source & Workflow</h2>
        <div class="grid-container">
            <div class="property-item">
                <span class="label">Repository:</span>
                <span id="repository"><a href="#" target="_blank" class="prominent"></a></span>
            </div>
            <div class="property-item">
                <span class="label">Branch:</span>
                <span id="branch"></span>
                (<span id="protectedBranch" class="status-protected"></span>)
            </div>
            <div class="property-item">
                <span class="label">Revision:</span>
                <a href="#" id="revision" target="_blank"></a>
            </div>
            <div class="property-item">
                <span class="label">Workflow:</span>
                <a href="#" id="workflow" target="_blank"></a>
            </div>
            <div class="property-item">
                <span class="label">Actor:</span>
                <span id="actor"></span>
            </div>
            <div class="property-item">
                <span class="label">Runner:</span>
                <span id="runner"></span>
            </div>
        </div>
    </section>

    <section class="report-section">
        <h2>Project Details</h2>
        <div class="grid-container">
            <div class="property-item">
                <span class="label">Project ID:</span>
                <span id="project-id"></span>
            </div>
            <div class="property-item optional-item" id="projectCodeContainer" style="display: none;">
                <span class="label">Project Code:</span>
                <span id="project-code"></span>
            </div>
            <div class="property-item">
                <span class="label">Application ID:</span>
                <span id="application-id"></span>
            </div>
            <div class="property-item optional-item" id="applicationIDIPContainer" style="display: none;"><span class="label">Application
                IDIP:</span>
                <span id="application-idip"></span>
            </div>
            <div class="property-item optional-item" id="platformContainer" style="display: none;">
                <span class="label">Platform:</span>
                <span id="platform"></span>
            </div>
            <div class="property-item optional-item" id="languagesContainer" style="display: none;">
                <span class="label">Languages:</span>
                <span id="languages"></span>
            </div>
            <div class="property-item optional-item" id="buildSystemContainer" style="display: none;"><span class="label">Build
                System:</span>
                <span id="build-system"></span>
            </div>
            <div class="property-item optional-item" id="deliveryContainer" style="display: none;">
                <span class="label">Delivery:</span>
                <span id="delivery"></span>
            </div>
        </div>
    </section>

    <section class="report-section">
        <h2>Team & Organisation</h2>
        <div class="grid-container">
            <div class="property-item">
                <span class="label">Organisation:</span>
                <a href="#" id="organisation" target="_blank"></a>
            </div>
            <div class="property-item">
                <span class="label">Team:</span>
                <a href="#" id="team-code" target="_blank"></a> (<span id="team-slug"></span>)
            </div>
            <div class="property-item">
                <span class="label">Collaborators:</span>
                <span id="collaborators"></span>
            </div>
        </div>
    </section>

    <section class="report-section" id="integrationsSection" style="display: none;">
        <h2>Integrations</h2>
        <div class="grid-container">
            <div class="property-item optional-item" id="issueTrackingContainer" style="display: none;"><span class="label">Issue
                Tracking (Jira):</span>
                <a href="#" id="issue-tracking" target="_blank"></a>
            </div>
            <div class="property-item optional-item" id="changeManagementContainer" style="display: none;"><span class="label">Change
                Management (ServiceNow):</span>
                <a href="#" id="change-management" target="_blank"></a>
            </div>
            <div class="property-item optional-item" id="teamCityContainer" style="display: none;">
                <span class="label">TeamCity Project:</span>
                <a href="#" id="team-city" target="_blank"></a>
            </div>
        </div>
    </section>


    <section class="report-section">
        <h2>Build Artefacts</h2>
        <ul class="artefacts-list" id="artefactsList">
        </ul>
    </section>

</div>

<script>
    // Basic script to handle optional field visibility and dynamic content
    document.addEventListener('DOMContentLoaded', function() {
        function setText(id, value) {
            const el = document.getElementById(id);
            if (el && value !== null && value !== undefined) el.textContent = value;
        }

        function setLink(id, href, text) {
            const el = document.getElementById(id);
            if (el && href !== null && href !== undefined) {
                el.href = href;
                if (text !== null && text !== undefined) el.textContent = text;
            }
        }

        function setVisibility(containerId, data) {
            const container = document.getElementById(containerId);
            if (container) {
                if (data !== null && data !== undefined && String(data).trim() !== "") {
                    container.style.display = ''; // Show if data exists
                    return true;
                } else {
                    container.style.display = 'none'; // Hide if no data
                    return false;
                }
            }
            return false;
        }

        function updateReportWithData(data) {
            // --- Populate Header ---
            setText('project-name', data.project.name);
            setText('application-name', data.application.name);
            if (setVisibility('projectDescriptionContainer', data.project.description)) {
                setText('project-description', data.project.description);
            }

            // --- Populate Build & Version ---
            setText('build-reference', data.build_reference);
            setLink('build-reference', `https://github.com/${data.organisation}/${data.repository}/actions/runs/${data.build_reference.split('/').pop()}`, data.build_reference);

            if (setVisibility('versionContainer', data.version)) {
                setText('version', data.version);
                setLink('version', `https://github.com/${data.organisation}/${data.repository}/releases/tag/v${data.version}`, `v${data.version}`);
            }

            const date = new Date(data.timestamp);
            setText('timestamp', date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'long' }));
            setText('project-maturity', data.maturity);
            setText('project-type', data.project.type);

            // --- Populate Source & Workflow ---
            setText('repository', data.repository);
            setLink('repository', `https://github.com/${data.organisation}/${data.repository}`, data.repository);
            setText('branch', data.branch);
            const protectedBranchEl = document.getElementById('protectedBranch');
            if (protectedBranchEl) {
                protectedBranchEl.textContent = data.protected_branch === "Yes" ? "Protected" : "Not Protected";
                protectedBranchEl.className = data.protected_branch === "Yes" ? 'status-protected' : 'status-unprotected';
            }
            setText('revision', data.revision.substring(0, 12) + '...');
            setLink('revision', `https://github.com/${data.organisation}/${data.repository}/commit/${data.revision}`, data.revision.substring(0,12)+'...');
            setText('workflow', data.workflow);
            setLink('workflow', `https://github.com/${data.organisation}/${data.repository}/blob/${data.branch}/.github/workflows/${data.workflow}`, data.workflow);
            setText('actor', data.actor);
            setText('runner', data.runner);

            // --- Populate Project Details ---
            setText('project-id', data.project.id);
            if(setVisibility('projectCodeContainer', data.project.code)){
                setText('project-code', data.project.code);
            }
            setText('application-id', data.application.id);
            setVisibility('applicationIDIPContainer', data.application.idip) && setText('application-idip', data.application.idip);
            setVisibility('platformContainer', data.platform) && setText('platform', data.platform);
            setVisibility('languagesContainer', data.languages) && setText('languages', data.languages);
            setVisibility('buildSystemContainer', data.build_system) && setText('build-system', data.build_system);
            setVisibility('deliveryContainer', data.delivery) && setText('delivery', data.delivery);

            // --- Populate Team & Organisation ---
            setText('organisation', data.organisation);
            setLink('organisation', `https://github.com/${data.organisation}`, data.organisation);
            setText('team-code', data.team.code);
            setLink('team-code', `https://github.com/orgs/${data.organisation}/teams/${data.team.slug}`, data.team.code);
            setText('team-slug', data.team.slug);
            setText('collaborators', data.collaborators);

            // --- Populate Integrations (and show section if any are present) ---
            let integrationsVisible = false;
            if (setVisibility('issueTrackingContainer', data.issue_tracking)) {
                setText('issue-tracking', data.issue_tracking);
                setLink('issue-tracking', `https://jira.example.com/browse/${data.issue_tracking}`, data.issue_tracking);
                integrationsVisible = true;
            }
            if (setVisibility('changeManagementContainer', data.change_management)) {
                setText('change-management', data.change_management);
                setLink('change-management', `https://servicenow.example.com/nav_to.do?uri=task.do?sysparm_query=number=${data.change_management}`, data.change_management);
                integrationsVisible = true;
            }
             if (setVisibility('teamCityContainer', data.team_city)) {
                setText('team-city', data.team_city);
                setLink('team-city', `https://teamcity.example.com/viewType.html?buildTypeId=${data.team_city}`, data.team_city);
                integrationsVisible = true;
            }

            const integrationsSection = document.getElementById('integrationsSection');
            if (integrationsSection && integrationsVisible) {
                integrationsSection.style.display = '';
            }

            // --- Populate Artefacts ---
            const artefactsList = document.getElementById('artefactsList');
            if (artefactsList && data.artifacts) {
                artefactsList.innerHTML = ''; // Clear static examples
                data.artifacts.forEach(artefact => {
                    const li = document.createElement('li');
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'artefact-name';
                    nameSpan.textContent = artefact.name;
                    li.appendChild(nameSpan);

                    const typeSpan = document.createElement('span');
                    typeSpan.className = 'artefact-type';
                    typeSpan.textContent = `(${artefact.type})`;
                    li.appendChild(typeSpan);

                    const link = document.createElement('a');
                    link.href = artefact.url;
                    link.textContent = 'Download/View';
                    link.target = '_blank'; // Open in new tab
                    li.appendChild(link);
                    artefactsList.appendChild(li);
                });
            }
        }

        // Fetch the JSON data file
        fetch('build-report-data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load build report data');
                }
                return response.json();
            })
            .then(data => {
                updateReportWithData(data);
            })
            .catch(error => {
                console.error('Error loading build report data:', error);
            });
    });
</script>

</body>
</html>
